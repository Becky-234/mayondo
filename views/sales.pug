doctype html
head
  meta(charset='UTF-8')
  meta(name='viewport' content='width=device-width, initial-scale=1.0')
  link(href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB' crossorigin='anonymous')
  link(rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css' integrity='sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==' crossorigin='anonymous' referrerpolicy='no-referrer')
  link(href='https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap' rel='stylesheet')
  link(rel='stylesheet' href='../css/sales.css')
  title Sales
aside.side-menu-container
  .logo-menu
    h2.logo MWF
    i.fa-solid.fa-bars
  ul.list
    li.list-item
      a(href='/dashboard')
        i.fa-solid.fa-house
        span.link-name Dashboard
    li.list-item
      a(href='/usersList')
        i.fa-solid.fa-users
        span.link-name Users
    li.list-item.active
      a(href='/sales')
        i.fa-solid.fa-cart-shopping
        span.link-name Sales
    li.list-item
      a(href='/stock')
        i.fa-solid.fa-truck
        span.link-name Stock
    li.list-item
      a(href='/products')
        i.fa-solid.fa-couch
        span.link-name Products
    li.list-item
      a(href='/settings')
        i.fa-solid.fa-gear
        span.link-name Settings
main.main-content
  nav.navbar.bg-body-tertiary.dashboard-header
    .container-fluid.d-flex.justify-content-end.align-items-center
      .d-flex.align-items-center
        a.logoutBtn(href='/index') Logout
                    // SUCCESS/ERROR MESSAGES
        if success
          .container.mt-3
            .alert.alert-success.alert-dismissible.fade.show(role="alert")
              i.fas.fa-check-circle.me-2
              strong Success! 
              | #{success}
              button.btn-close(type="button" data-bs-dismiss="alert")
        if error
          .container.mt-3
            .alert.alert-danger.alert-dismissible.fade.show(role="alert")
              i.fas.fa-exclamation-circle.me-2
              strong Error! 
              | #{error}
              button.btn-close(type="button" data-bs-dismiss="alert")
  section#dash-top.dash
    .row
      .col-md-3
        .dash-card
          .card-body
            i.fa-solid.fa-money-bill-trend-up
            h5.card-title Total Sales
            p.card-text Shs. #{dashboardMetrics ? (dashboardMetrics.totalSalesRaw + dashboardMetrics.totalSalesFurniture).toLocaleString() : '0'}
                    .breakdown
                        small Raw: Shs. #{dashboardMetrics ? dashboardMetrics.totalSalesRaw.toLocaleString() : '0'}
                        br
                        small Furniture: Shs. #{dashboardMetrics ? dashboardMetrics.totalSalesFurniture.toLocaleString() : '0'}
        
      .col-md-3
        .dash-card
          .card-body
            i.fa-solid.fa-phone-volume
            h5.card-title Total Orders
            p.card-text  #{dashboardMetrics ? dashboardMetrics.totalOrders : '0'}
      .col-md-3
        .dash-card
          .card-body
            i.fa-solid.fa-scale-balanced
            h5.card-title Total Sold Products
            p.card-text #{dashboardMetrics ? (dashboardMetrics.totalSoldRaw + dashboardMetrics.totalSoldFurniture) : '0'} units
                    .breakdown
                        small Raw: #{dashboardMetrics ? dashboardMetrics.totalSoldRaw : '0'}
                        br
                        small Furniture: #{dashboardMetrics ? dashboardMetrics.totalSoldFurniture : '0'}
      .col-md-3
        .dash-card
          .card-body
              i.fa-solid.fa-chart-pie
              h5.card-title Sales Distribution
              .distribution
                  .raw-material
                      small Raw: #{dashboardMetrics ? Math.round((dashboardMetrics.totalSalesRaw / (dashboardMetrics.totalSalesRaw + dashboardMetrics.totalSalesFurniture)) * 100) || 0 : '0'}%
                  .furniture
                      small Furniture: #{dashboardMetrics ? Math.round((dashboardMetrics.totalSalesFurniture / (dashboardMetrics.totalSalesRaw + dashboardMetrics.totalSalesFurniture)) * 100) || 0 : '0'}%
    br
    br
    br  
  #including.include
    a.btns(href='addSale') Add Sale
    a#downloadExcel.btns Download Excel
    a#downloadPdf.btns Download PDF
    
    .table-filter(style="display: inline-block; margin-left: 20px;")
        label.filter-label(for="productFilter") Filter by:
        select#productFilter.filter-dropdown
            option(value="all") All Products
            option(value="raw") Raw Materials Only
            option(value="furniture") Furniture Only
    
    input#searchSale(type='search' placeholder='Search...')
  section
    table#salesTable.table-content
     thead.row-one
      tr
          th Customer Name
          th Customer Contact
          th Product Name
          th Product Type
          th Quantity
          th Unit Price UGX
          th Transport Check 
          th Total Price UGX
          th Type of Payment
          th Date
          th Sales Agent Name
          if currentUser.role === "Manager"
            th Actions
      tbody.row-others
        if items.length 
          each item in items 
            tr
              td #{item.name}
              td #{item.contact}
              td #{item.nproduct}
              td #{item.tproduct}
              td #{item.quantity}
              td #{item.unitPrice.toLocaleString()}
              td #{item.transportCheck ? 'Yes' : 'No'}
              td #{Math.round(item.totalPrice).toLocaleString()}
              td #{item.payment}
              td #{new Date(item.date).toLocaleDateString()}
              td #{item.agent.name}
              if currentUser.role === "Manager"
                td.actions
                  a.btn-icon(href=`/editSales/${item._id}` title='Edit')
                    i.fas.fa-edit
                  form(method='post', action='/deleteSale', style='display:inline')
                    input(type='hidden', name='id', value=item._id)
                    button.btn-icon(type='submit', title='Delete', onclick="return confirm('Are you sure you want to delete this item?')")
                      i.fas.fa-trash
                  form(method='post', action=`/getReceipt/${item._id}`, style='display:inline')
                    input(type='hidden', name='id', value=item._id)
                    button.btn-icon(type='submit', title='Receipt')
                      i.fas.fa-file-invoice
        //- else
        //-   tr
        //-     td(colspan=currentUser && currentUser.role === "Manager" ? 12 : 11 style="text-align: center;") No sales records found
    br
    br
    h5#notFound Not Found!
//  SheetJS
script(src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js")
// jsPDF + AutoTable
script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
script(src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js")
script(src='/javascript/sales.js')
script(src='https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js' integrity='sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI' crossorigin='anonymous')
